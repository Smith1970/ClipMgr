# ClipMgr

#### 简介
这个模块通过 hook ClipboardManager.setPrimaryClip() 函数，拦截所有尝试修改剪贴板的操作。

#### 更新日志

1.1:
修复：某些机型上无法实时弹出对话框的问题
修复：搜索界面修改规则后，界面无法同步显示的问题
修复：某些应用(如 via)上剪贴板内容为 null 的问题
修复：某些应用无法弹出 Toast 的问题

修复：应用连续操作多次剪贴板时，后续对话框无法弹出的问题
新增：清除历史记录 (主界面-右上角菜单-清除历史)
调整：去掉了对话框弹出动画
调整：去掉了部分文字错误
调整：请求权限界面不会显示在“最近应用列表”

1.2:
修复：Flyme8 某些机型无限套娃的 bug
修复：某些机型 Toast 的问题

1.3:
新增：激进模式（主界面-右上角菜单-激进模式）
调整：弹窗机制

很多用户反馈说无法正常弹窗，必须要保留后台才行。
仔细想想可以理解，毕竟我是在后台服务里 `startActivity()`，
如果 ROM 厂商限制严格一点，很明显就跪了，而且也不支持 Android 10。
所以这个版本我尝试直接在宿主进程打开 Dialog，
但又有一个挺麻烦的事情，就是不同应用有不同的 Theme，
这直接导致 Dialog 样式不统一 (`android.R.style.Theme_Material_Light_Dialog_NoActionBar_MinWidth`)

考虑到大多数修改剪贴板的事件都是在前台进行，
这个版本尝试使用当前应用 `startActivity()`，
这有助于摆脱后台限制。但正因为如此，我不得不把所有
核心 Hook 逻辑从我自己的进程转移到目标进程。
随之而来的问题是：之前实现起来很简单的 `ClipData` 队列已经不适用了。
我使用了一个很不优雅的方法，直接保留最新的 `ClipData`。
它保证了如果目标应用在弹窗之前连续调用多次 `setPrimaryClip()`，
我也能展示给用户最新的数据。但遗憾的是，
如果应用在弹窗之后，用户响应操作之前再次 `setPrimaryClip()`，
后面的 `ClipData` 会丢失。

对于剩下的小部分情况，也就是后台应用修改剪贴板，
Android 10 的话应该弹不出来，因此也会丢失掉修改事件。
不过没关系，就算没有我，Android 10 也会阻止它的。

现在 Android 10 还没有测试，毕竟我没有真机，
模拟器的话由于我修改不了 system.img ，Xposed 也是一个问题。
但我有一点头绪，就是模拟 Magisk 直接来一个 mount bind，硬上 Xposed。

关于 Magisk 模块，我不打算继续搞下去了，毕竟 Magisk 能够做到的实在是有限。
在上个版本里，我使用 Riru 结合动态代理勉强实现了这个功能。
但同样的 Hook 代码我要写两份————换句话说，一旦我修改了 Hook 逻辑，
就必须更新 Magisk 模块，否则会因为接口不统一产生难以预料的后果。
就算用户能保证同步更新，一旦我需要 hook 更多的函数，比如
`Application.onCreate()`，这是不可能通过动态代理做到的。
从另一个方面来考虑，既然用户有了 Magisk 和 Riru，
Xposed 应该是水到渠成的(Edxposed)，二者的用户区间高度重合，
也没有了维护下去的意义。

从 12 月 10 日上线到现在，这个 “很简单” 的模块花费了我相当多的时间
和精力，再加上一些莫名其妙的问题 (三星会修改本地策略)，
我开始怀疑是不是本末倒置了。

